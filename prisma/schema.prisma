generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

model User {
  id                   String         @id @default(cuid())
  username             String         @unique
  name                 String?
  email                String         @unique
  password             String
  role                 Role           @default(CUSTOMER)
  createdAt            DateTime       @default(now())
  notificationsEnabled Boolean        @default(true)

  // Relations
  profile             Profile?
  earnings            Earnings?
  payoutMethod        PayoutMethod?   // Added relation to PayoutMethod
  transactions        Transaction[]
  notifications       Notification[]
  
  // Orders
  customerOrders      Order[]        @relation("CustomerOrders")
  providerOrders      Order[]        @relation("ProviderOrders")
  reviewsGiven        Review[]
  
  // Proposals
  proposalsSent       Proposal[]     @relation("CustomerProposals")
  proposalsReceived    Proposal[]     @relation("ProviderProposals")
}

enum Role {
  WORKER
  CUSTOMER
}

// ==========================================
// PROFILE & TALENT DATA
// ==========================================

model Profile {
  id          String       @id @default(cuid())
  userId      String       @unique
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String?
  languages   String[]     @default([])
  about       String?      @db.Text
  location    String?
  image       String?      // This acts as the Avatar
  
  gigs        Gig[]
  experiences Experience[]
  educations  Education[]
  skills      Skill[]
  reviews     Review[]     @relation("ProfileReviews") // Reviews received
  portfolio   Portfolio[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Experience {
  id          String    @id @default(cuid())
  title       String
  company     String
  description String    @db.Text
  startDate   DateTime?
  endDate     DateTime?
  current     Boolean   @default(false)
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model Education {
  id          String    @id @default(cuid())
  degree      String
  institution String
  startDate   DateTime?
  endDate     DateTime?
  current     Boolean   @default(false)
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model Skill {
  id        String  @id @default(cuid())
  name      String
  level     Int     @default(1)
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model Portfolio {
  id           String    @id @default(cuid())
  title        String
  description  String    @db.Text
  projectImage String?
  hours        Int?      
  rate         Float?    
  cost         Float?    
  startDate    DateTime
  endDate      DateTime?
  location     String?
  profileId    String
  profile      Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// ==========================================
// GIGS & ANALYTICS
// ==========================================

model Gig {
  id           String       @id @default(cuid())
  title        String
  description  String       @db.Text
  price        Float
  location     String
  category     String?
  serviceType  String?      // e.g., "One-time", "Recurring"
  keywords     String?      // Comma separated string
  status       String?      @default("active")
  image        String?      // Cover image
  
  // Analytics
  totalViews   Int          @default(0)
  totalClicks  Int          @default(0)
  impressions  Impression[]
  clicks       Click[]

  // Relations
  profileId    String
  profile      Profile      @relation(fields: [profileId], references: [id], onDelete: Cascade)
  reviews      Review[]
  orders       Order[]
  proposals    Proposal[]
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model Impression {
  id        String   @id @default(cuid())
  gigId     String
  gig       Gig      @relation(fields: [gigId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Click {
  id        String   @id @default(cuid())
  gigId     String
  gig       Gig      @relation(fields: [gigId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

// ==========================================
// TRANSACTIONS, ORDERS & PROPOSALS
// ==========================================

model Proposal {
  id             String         @id @default(cuid())
  description    String         @db.Text
  estimatedHours Int
  startDate      DateTime
  deadlineDays   Int
  location       String
  offeredPrice   Float
  status         ProposalStatus @default(PENDING)
  images         String[]       // Array of Cloudinary URLs
  
  // Relations
  gigId          String
  gig            Gig            @relation(fields: [gigId], references: [id], onDelete: Cascade)
  isReviewed  Boolean  @default(false)

  customerId     String
  customer       User           @relation("CustomerProposals", fields: [customerId], references: [id])
  
  providerId     String
  provider       User           @relation("ProviderProposals", fields: [providerId], references: [id])

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  order          Order?
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
  IN_PROGRESS
  COMPLETED
  SUBMITTED
}

model Order {
  id          String   @id @default(cuid())
  status      String   @default("IN_PROGRESS") 
  totalPrice  Float
  
  gigId       String
  gig         Gig      @relation(fields: [gigId], references: [id])

  customerId  String
  customer    User     @relation("CustomerOrders", fields: [customerId], references: [id])

  providerId  String
  provider    User     @relation("ProviderOrders", fields: [providerId], references: [id])

  proof       OrderProof?
  
  // NEW: Track if the order has been rated
  isReviewed  Boolean  @default(false)
  review      Review?

  isSettled   Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  proposalId  String?  @unique
  proposal    Proposal? @relation(fields: [proposalId], references: [id])
}

model Review {
  id                 String   @id @default(cuid())
  
  // Breakdown ratings
  rating             Float    // This is the calculated average (e.g., 4.7)
  communication      Int      // 1-5
  serviceQuality     Int      // 1-5 (Service as Described)
  valueForMoney      Int      // 1-5 (Recommend)
  
  comment            String?  @db.Text
  showcaseImage      String?  // The image URL selected from OrderProof
  
  // Relations
  orderId            String   @unique
  order              Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  gigId              String
  gig                Gig      @relation(fields: [gigId], references: [id], onDelete: Cascade)
  
  // Profile receiving the review
  profileId          String
  profile            Profile  @relation("ProfileReviews", fields: [profileId], references: [id], onDelete: Cascade)
  
  // User giving the review
  reviewerId         String
  reviewer           User     @relation(fields: [reviewerId], references: [id])

  createdAt          DateTime @default(now())
}

model OrderProof {
  id           String   @id @default(cuid())
  orderId      String   @unique
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  description  String?  @db.Text
  externalLink String?
  images       String[] // Cloudinary URLs for the 1-3 proof images
  
  submittedAt  DateTime @default(now())
}

model Earnings {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  totalBalance  Float    @default(0.0)
  withdrawn     Float    @default(0.0)
  pendingAmount Float    @default(0.0)
  lastUpdated   DateTime @default(now())
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Float
  type        String   // "payout", "deposit", "payment"
  status      String   // "pending", "completed", "failed"
  description String
  createdAt   DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  link      String?  
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ==========================================
// PAYOUT METHOD (NEW)
// ==========================================

model PayoutMethod {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String   // "BANK", "PAYPAL", "STRIPE"
  details     String   // Encrypted email or account number
  provider    String?  // e.g., "Chase", "PayPal Inc"
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}